<style>
  .category-card {
    transition: all 0.2s ease;
    border: 1px solid #e2e8f0;
  }
  .category-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    border-color: #cbd5e1;
  }
  .status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
  }

  /* Modal Styles (Scoped) */
  .modal {
    display: none;
    position: fixed;
    z-index: 60;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
  }
  /* Override flex display for modals when active */
  .modal.active { display: flex !important; }

  .modal-content {
    background-color: white;
    padding: 1.5rem;
    border-radius: 16px;
    width: 95%;
    max-width: 450px;
    position: relative;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    animation: scaleUp 0.2s ease-out;
  }
  @keyframes scaleUp {
    from { transform: scale(0.95); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  @media (max-width: 768px) {
    .category-grid { grid-template-columns: 1fr !important; }
    .action-buttons { flex-direction: column; gap: 0.5rem; }
  }
</style>

<div class="fade-in">
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
      <div class="flex items-center">
        <div class="p-3 bg-blue-100 rounded-lg mr-4">
          <i class="fas fa-tags text-blue-600 text-xl"></i>
        </div>
        <div>
          <p class="text-gray-500 text-sm">Total Kategori</p>
          <p class="text-2xl font-bold text-gray-800">{{.TotalKategori}}</p>
        </div>
      </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
      <div class="flex items-center">
        <div class="p-3 bg-green-100 rounded-lg mr-4">
          <i class="fas fa-check-circle text-green-600 text-xl"></i>
        </div>
        <div>
          <p class="text-gray-500 text-sm">Kategori Aktif</p>
          <p class="text-2xl font-bold text-gray-800">{{ .KategoriAktif}}</p>
        </div>
      </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
      <div class="flex items-center">
        <div class="p-3 bg-yellow-100 rounded-lg mr-4">
          <i class="fas fa-pause-circle text-yellow-600 text-xl"></i>
        </div>
        <div>
          <p class="text-gray-500 text-sm">Kategori Nonaktif</p>
          <p class="text-2xl font-bold text-gray-800">{{ .KategoriNonaktif}}</p>
        </div>
      </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
      <div class="flex items-center">
        <div class="p-3 bg-purple-100 rounded-lg mr-4">
          <i class="fas fa-boxes text-purple-600 text-xl"></i>
        </div>
        <div>
          <p class="text-gray-500 text-sm">Produk Terkait</p>
          <p class="text-2xl font-bold text-gray-800">{{ .TotalProduk}}</p>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow p-4 mb-8">
    <div class="filter-section flex flex-col md:flex-row items-end gap-4">
      <div class="flex-1 w-full">
        <label class="block text-sm font-medium text-gray-700 mb-2">Cari Kategori</label>
        <div class="relative">
          <input type="text" id="search-input" placeholder="Nama kategori..."
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none"/>
          <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
      </div>
      <div class="w-full md:w-auto">
        <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition text-sm w-full flex items-center justify-center gap-2"
                onclick="showAddCategoryModal()">
          <i class="fas fa-plus"></i> Tambah Kategori
        </button>
      </div>
    </div>
  </div>
  <div id="categories-container" class="category-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    {{ range .Data }}
    <div class="category-card bg-white rounded-xl p-5">
      <div class="text-center mb-4">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
          <i class="fas fa-{{ if .Icon }}{{ .Icon }}{{ else }}tags{{ end }} text-blue-600 text-2xl"></i>
        </div>
        <h3 class="font-semibold text-gray-800">{{ .NamaCategory }}</h3>
      </div>
      <div class="space-y-2 mb-4 text-sm">
        <div class="flex justify-between items-center">
          <span class="text-gray-600">Status:</span>
          {{ if eq .Status "active" }}
          <span class="flex items-center text-green-600 font-medium"><span class="status-indicator bg-green-500"></span> Aktif</span>
          {{ else }}
          <span class="flex items-center text-red-600 font-medium"><span class="status-indicator bg-red-500"></span> Nonaktif</span>
          {{ end }}
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Deskripsi:</span>
          <span class="text-xs truncate max-w-[100px]">{{ .Description }}</span>
        </div>
      </div>
      <div class="flex action-buttons gap-2">
        <button class="flex-1 px-3 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition text-xs"
                onclick="showEditCategoryModal('{{ .CategoryUID }}', '{{ .NamaCategory }}', '{{ .Description }}', '{{ .Icon }}', '{{ .Status }}')">
          <i class="fas fa-edit mr-1"></i> Edit
        </button>
        <button class="px-3 py-2 bg-danger text-white rounded-lg hover:bg-red-700 transition text-xs"
                onclick="deleteCategory('{{ .CategoryUID }}')">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
    {{end}}
  </div>
</div>

<div id="add-category-modal" class="modal">
  <div class="modal-content">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-gray-800">Tambah Kategori Baru</h3>
      <button onclick="hideAddCategoryModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
    </div>
    <form id="form-add" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kategori *</label>
        <input type="text" id="add-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
        <textarea id="add-desc" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Ikon Kategori (FontAwesome)</label>
        <select id="add-icon" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
          <option value="pencil-alt">üìù Alat Tulis</option>
          <option value="book">üìö Buku</option>
          <option value="cookie">üç™ Snack</option>
          <option value="glass-whiskey">ü•§ Minuman</option>
          <option value="tshirt">üëï Seragam</option>
        </select>
      </div>
      <div class="flex items-center">
        <input type="checkbox" id="add-active" checked class="rounded border-gray-300 text-primary focus:ring-primary">
        <label for="add-active" class="ml-2 text-sm text-gray-700">Status Aktif</label>
      </div>
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="hideAddCategoryModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">Batal</button>
        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg">Simpan</button>
      </div>
    </form>
  </div>
</div>

<div id="edit-category-modal" class="modal">
  <div class="modal-content">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-gray-800">Edit Kategori</h3>
      <button onclick="hideEditCategoryModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
    </div>
    <form id="form-edit" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kategori *</label>
        <input type="text" id="edit-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
        <textarea id="edit-desc" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Ikon Kategori</label>
        <select id="edit-icon" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
          <option value="pencil-alt">üìù Alat Tulis</option>
          <option value="book">üìö Buku</option>
          <option value="cookie">üç™ Snack</option>
          <option value="glass-whiskey">ü•§ Minuman</option>
          <option value="tshirt">üëï Seragam</option>
        </select>
      </div>
      <div class="flex items-center">
        <input type="checkbox" id="edit-active" class="rounded border-gray-300 text-primary focus:ring-primary">
        <label for="edit-active" class="ml-2 text-sm text-gray-700">Status Aktif</label>
      </div>
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="hideEditCategoryModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">Batal</button>
        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg">Simpan Perubahan</button>
      </div>
    </form>
  </div>
</div>

<div id="delete-category-modal" class="modal">
  <div class="modal-content text-center">
    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
    </div>
    <h3 class="text-lg font-semibold text-gray-800 mb-2">Konfirmasi Hapus</h3>
    <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus kategori ini?</p>
    <div class="flex justify-center space-x-3">
      <button onclick="hideDeleteCategoryModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">Batal</button>
      <button id="btn-confirm-delete" class="px-4 py-2 bg-danger text-white rounded-lg hover:bg-red-700">Hapus</button>
    </div>
  </div>
</div>

<script>
  let currentCategoryId = null;

  const API_URL = '/categories';

  // ================= TAMPILAN MODAL =================
  function showAddCategoryModal() {
    document.getElementById('form-add').reset();
    document.getElementById('add-category-modal').classList.add('active');
  }
  function hideAddCategoryModal() { document.getElementById('add-category-modal').classList.remove('active'); }

  // Isi form edit secara otomatis saat tombol ditekan
  function showEditCategoryModal(uid, name, desc, icon, status) {
    currentCategoryId = uid;
    document.getElementById('edit-name').value = name;
    document.getElementById('edit-desc').value = desc;
    document.getElementById('edit-icon').value = icon;
    document.getElementById('edit-active').checked = (status === 'active');

    document.getElementById('edit-category-modal').classList.add('active');
  }
  function hideEditCategoryModal() { document.getElementById('edit-category-modal').classList.remove('active'); }

  function deleteCategory(uid) {
    currentCategoryId = uid;
    document.getElementById('delete-category-modal').classList.add('active');
  }
  function hideDeleteCategoryModal() { document.getElementById('delete-category-modal').classList.remove('active'); }

  // ================= PROSES AJAX (FETCH API) =================

  // 1. TAMBAH (CREATE)
  document.getElementById('form-add').addEventListener('submit', async function(e) {
    e.preventDefault();

    const payload = {
      name_category: document.getElementById('add-name').value,
      description: document.getElementById('add-desc').value,
      icon: document.getElementById('add-icon').value,
      status: document.getElementById('add-active').checked ? "active" : "inactive"
    };

    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        hideAddCategoryModal();
        window.location.reload();
      } else {
        alert("Gagal menambahkan kategori.");
      }
    } catch (error) {
      console.error(error);
    }
  });

  // 2. EDIT (UPDATE)
  document.getElementById('form-edit').addEventListener('submit', async function(e) {
    e.preventDefault();

    const payload = {
      name_category: document.getElementById('edit-name').value,
      description: document.getElementById('edit-desc').value,
      icon: document.getElementById('edit-icon').value,
      status: document.getElementById('edit-active').checked ? "active" : "inactive"
    };

    try {
      const response = await fetch(`${API_URL}/${currentCategoryId}`, {
        method: 'PUT', // Sesuaikan dengan method router Golang Anda (bisa juga PATCH)
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        hideEditCategoryModal();
        window.location.reload();
      } else {
        alert("Gagal mengupdate kategori.");
      }
    } catch (error) {
      console.error(error);
    }
  });

  // 3. HAPUS (DELETE)
  document.getElementById('btn-confirm-delete').addEventListener('click', async function() {
    try {
      const response = await fetch(`${API_URL}/${currentCategoryId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        hideDeleteCategoryModal();
        window.location.reload();
      } else {
        alert("Gagal menghapus kategori.");
      }
    } catch (error) {
      console.error(error);
    }
  });

  // Filter Search
  const searchInput = document.getElementById('search-input');
  if(searchInput) {
    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase().trim();
      const categories = document.querySelectorAll('.category-card');

      categories.forEach(category => {
        const categoryName = category.querySelector('h3').textContent.toLowerCase();
        category.style.display = (searchTerm === '' || categoryName.includes(searchTerm)) ? 'block' : 'none';
      });
    });
  }
</script>