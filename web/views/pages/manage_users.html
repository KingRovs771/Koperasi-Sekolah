<style>
    .user-card {
        transition: all 0.2s ease;
        border: 1px solid #e2e8f0;
    }
    .user-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        border-color: #cbd5e1;
    }
    .role-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 60;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        align-items: center;
        justify-content: center;
    }
    .modal.active { display: flex !important; }

    .modal-content {
        background-color: white;
        padding: 1.5rem;
        border-radius: 16px;
        width: 95%;
        max-width: 450px;
        position: relative;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: scaleUp 0.2s ease-out;
    }
    @keyframes scaleUp {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    @media (max-width: 768px) {
        .user-grid { grid-template-columns: 1fr !important; }
        .action-buttons { flex-direction: column; gap: 0.5rem; }
    }

    /* Loading Spinner helper */
    .btn-loading {
        opacity: 0.7;
        pointer-events: none;
    }
</style>

<div class="fade-in">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
            <div class="flex items-center">
                <div class="p-3 bg-blue-100 rounded-lg mr-4">
                    <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Total Pengguna</p>
                    <p class="text-2xl font-bold text-gray-800">{{ len .Data }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
            <div class="flex items-center">
                <div class="p-3 bg-green-100 rounded-lg mr-4">
                    <i class="fas fa-user-shield text-green-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Administrator</p>
                    <p class="text-2xl font-bold text-gray-800">{{ .TotalAdmin }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
            <div class="flex items-center">
                <div class="p-3 bg-purple-100 rounded-lg mr-4">
                    <i class="fas fa-cash-register text-purple-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Kasir</p>
                    <p class="text-2xl font-bold text-gray-800">{{ .TotalKasir}}</p>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
            <div class="flex items-center">
                <div class="p-3 bg-yellow-100 rounded-lg mr-4">
                    <i class="fas fa-user-tie text-yellow-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Supervisor</p>
                    <p class="text-2xl font-bold text-gray-800">{{ .TotalSpv }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow p-4 mb-8">
        <div class="filter-section flex flex-col md:flex-row items-end gap-4">
            <div class="flex-1 w-full">
                <label class="block text-sm font-medium text-gray-700 mb-2">Cari Pengguna</label>
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Nama, username, email..."
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none"/>
                    <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            <div class="w-full md:w-auto min-w-[150px]">
                <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                <select id="role-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
                    <option value="">Semua Role</option>
                    <option value="administrator">Administrator</option>
                    <option value="kasir">Kasir</option>
                    <option value="supervisor">Supervisor</option>
                </select>
            </div>
            <div class="w-full md:w-auto min-w-[120px]">
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select id="status-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
                    <option value="">Semua Status</option>
                    <option value="active">Aktif</option>
                    <option value="inactive">Tidak Aktif</option>
                </select>
            </div>
            <div class="w-full md:w-auto">
                <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition text-sm w-full flex items-center justify-center gap-2"
                        onclick="showAddUserModal()">
                    <i class="fas fa-plus"></i> Tambah Pengguna
                </button>
            </div>
        </div>
    </div>

    <div id="users-container" class="user-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {{range .Data}}
        <div class="user-card bg-white rounded-xl p-5">
            <div class="text-center mb-4">
                <img src="https://ui-avatars.com/api/?name={{ .NamaLengkap }}&background=1e40af&color=fff" alt="{{ .NamaLengkap }}" class="w-16 h-16 rounded-full mx-auto mb-3 border-2 border-blue-100">
                <h3 class="font-semibold text-gray-800">{{ .NamaLengkap}}</h3>
                <p class="text-xs text-gray-500">{{.Email}}</p>
            </div>
            <div class="space-y-2 mb-4 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-500">Username:</span>
                    <span class="font-medium">{{ .Username }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-500">Role:</span>
                    <span class="role-badge {{if eq .Role "admin"}}bg-blue-100 text-blue-800{{else if eq .Role "supervisor"}}bg-yellow-100 text-yellow-800{{else}}bg-purple-100 text-purple-800{{end}}">
                    {{ .Role}}
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-500">Status:</span>
                    <span class="flex items-center {{if eq .Status "active"}}text-green-600{{else}}text-red-600{{end}} font-medium">
                    <span class="status-indicator {{if eq .Status "active"}}bg-green-500{{else}}bg-red-500{{end}}"></span> {{.Status}}
                    </span>
                </div>
            </div>
            <div class="flex action-buttons gap-2">
                <button class="flex-1 px-3 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition text-xs" onclick="showEditUserModal('{{.UsersUID}}')">
                    <i class="fas fa-edit mr-1"></i> Edit
                </button>
                <button class="px-3 py-2 bg-danger text-white rounded-lg hover:bg-red-700 transition text-xs" onclick="deleteUser('{{.UsersUID}}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        {{ end }}
    </div>
</div>

<div id="add-user-modal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Tambah Pengguna Baru</h3>
            <button onclick="hideAddUserModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
        </div>
        <form id="add-user-form" class="space-y-4" onsubmit="submitAddUser(event)">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                <input type="text" name="nama_lengkap" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Username *</label>
                <input type="text" name="username" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                <input type="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                <input type="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                <select name="role" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
                    <option value="">Pilih Role</option>
                    <option value="administrator">Administrator</option>
                    <option value="kasir">Kasir</option>
                    <option value="supervisor">Supervisor</option>
                </select>
            </div>
            <input type="hidden" name="status" value="active">

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideAddUserModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Batal</button>
                <button type="submit" id="btn-save-add" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </form>
    </div>
</div>

<div id="edit-user-modal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Edit Pengguna</h3>
            <button onclick="hideEditUserModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
        </div>
        <form id="edit-user-form" class="space-y-4" onsubmit="submitEditUser(event)">
            <input type="hidden" id="edit-uid">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                <input type="text" id="edit-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Username *</label>
                <input type="text" id="edit-username" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                <input type="email" id="edit-email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Password Baru</label>
                <input type="password" id="edit-password" placeholder="Biarkan kosong jika tidak ingin mengubah" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                <select id="edit-role" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
                    <option value="administrator">Administrator</option>
                    <option value="kasir">Kasir</option>
                    <option value="supervisor">Supervisor</option>
                </select>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="edit-status" class="rounded border-gray-300 text-primary focus:ring-primary">
                <label for="edit-status" class="ml-2 text-sm text-gray-700">Status Aktif</label>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideEditUserModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Batal</button>
                <button type="submit" id="btn-save-edit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700">Simpan Perubahan</button>
            </div>
        </form>
    </div>
</div>

<div id="delete-user-modal" class="modal">
    <div class="modal-content text-center">
        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Konfirmasi Hapus</h3>
        <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus pengguna ini? Tindakan ini tidak dapat dibatalkan.</p>
        <div class="flex justify-center space-x-3">
            <button onclick="hideDeleteUserModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Batal</button>
            <button onclick="confirmDeleteUser()" id="btn-confirm-delete" class="px-4 py-2 bg-danger text-white rounded-lg hover:bg-red-700">Hapus</button>
        </div>
    </div>
</div>

<script>
    let currentUserId = null;

    // --- Modal Functions UI ---
    function showAddUserModal() {
        document.getElementById('add-user-modal').classList.add('active');
    }

    function hideAddUserModal() {
        document.getElementById('add-user-modal').classList.remove('active');
        document.getElementById('add-user-form').reset();
    }

    function hideEditUserModal() {
        document.getElementById('edit-user-modal').classList.remove('active');
    }

    function deleteUser(uid) {
        currentUserId = uid;
        document.getElementById('delete-user-modal').classList.add('active');
    }

    function hideDeleteUserModal() {
        document.getElementById('delete-user-modal').classList.remove('active');
    }

    // --- API & Logic Functions ---

    // 1. Fetch Data untuk Edit (GET /users/:uid)
    async function showEditUserModal(uid) {
        currentUserId = uid;
        const modal = document.getElementById('edit-user-modal');

        // Reset form dulu
        document.getElementById('edit-user-form').reset();

        try {
            // Asumsi route endpoint backend adalah /users/:uid
            const response = await fetch(`/users/${uid}`);
            const result = await response.json();

            if (result.Success) {
                const user = result.Data;

                // Populate Form
                document.getElementById('edit-uid').value = user.users_uid;
                document.getElementById('edit-name').value = user.nama_lengkap;
                document.getElementById('edit-username').value = user.username;
                document.getElementById('edit-email').value = user.email;
                document.getElementById('edit-role').value = user.role;

                // Set Checkbox (Check if status is 'active')
                const isActive = user.status === 'active';
                document.getElementById('edit-status').checked = isActive;

                modal.classList.add('active');
            } else {
                alert('Gagal mengambil data user: ' + result.Error);
            }
        } catch (error) {
            console.error(error);
            alert('Terjadi kesalahan saat mengambil data.');
        }
    }

    // 2. Submit Add User (POST /users)
    async function submitAddUser(event) {
        event.preventDefault();
        const btn = document.getElementById('btn-save-add');
        btn.classList.add('btn-loading');
        btn.innerHTML = 'Menyimpan...';

        const formData = new FormData(event.target);
        // Convert formData to JSON object
        const data = Object.fromEntries(formData.entries());

        // Asumsi mapping: form name="nama_lengkap" -> struct field NamaLengkap
        // Backend Go parser otomatis handle field jika tag json sesuai atau field name sama

        try {
            const response = await fetch('/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                alert('Pengguna berhasil ditambahkan!');
                location.reload(); // Refresh untuk update tabel
            } else {
                alert('Gagal: ' + (result.error || 'Terjadi kesalahan'));
            }
        } catch (error) {
            alert('Error koneksi ke server.');
        } finally {
            btn.classList.remove('btn-loading');
            btn.innerHTML = 'Simpan';
        }
    }

    // 3. Submit Edit User (PUT /users/:uid)
    async function submitEditUser(event) {
        event.preventDefault();
        const btn = document.getElementById('btn-save-edit');
        btn.classList.add('btn-loading');
        btn.innerHTML = 'Menyimpan...';

        const uid = document.getElementById('edit-uid').value;
        const isActive = document.getElementById('edit-status').checked ? 'active' : 'inactive';

        // Sesuai struct UpdateInput di Go
        const payload = {
            name: document.getElementById('edit-name').value,
            username: document.getElementById('edit-username').value,
            email: document.getElementById('edit-email').value,
            password: document.getElementById('edit-password').value,
            role: document.getElementById('edit-role').value,
            is_active: isActive // Convert boolean checkbox to string
        };

        try {
            const response = await fetch(`/users/${uid}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (response.ok) {
                alert('Data pengguna berhasil diperbarui!');
                location.reload();
            } else {
                alert('Gagal update: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error koneksi ke server.');
        } finally {
            btn.classList.remove('btn-loading');
            btn.innerHTML = 'Simpan Perubahan';
        }
    }

    // 4. Confirm Delete (DELETE /users/:uid)
    async function confirmDeleteUser() {
        if (!currentUserId) return;

        const btn = document.getElementById('btn-confirm-delete');
        btn.innerHTML = 'Menghapus...';

        try {
            const response = await fetch(`/users/${currentUserId}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (response.ok) {
                alert('Pengguna berhasil dihapus!');
                location.reload();
            } else {
                alert('Gagal menghapus: ' + (result.Error || result.error));
            }
        } catch (error) {
            alert('Error koneksi ke server.');
        } finally {
            hideDeleteUserModal();
        }
    }

    // Close Modals on Click Outside
    window.onclick = function(event) {
        const addModal = document.getElementById('add-user-modal');
        const editModal = document.getElementById('edit-user-modal');
        const deleteModal = document.getElementById('delete-user-modal');

        if (event.target === addModal) hideAddUserModal();
        if (event.target === editModal) hideEditUserModal();
        if (event.target === deleteModal) hideDeleteUserModal();
    };

    // Filter Logic (Client Side)
    const searchInput = document.getElementById('search-input');
    const roleFilter = document.getElementById('role-filter');
    const statusFilter = document.getElementById('status-filter');

    function filterUsers() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const roleVal = roleFilter.value.toLowerCase(); // Compare lowercase
        const statusVal = statusFilter.value;
        const users = document.querySelectorAll('.user-card');

        users.forEach(user => {
            const userName = user.querySelector('h3').textContent.toLowerCase();
            const userEmail = user.querySelector('p.text-xs.text-gray-500').textContent.toLowerCase();
            const roleBadge = user.querySelector('.role-badge').textContent.toLowerCase().trim();
            const statusText = user.querySelector('.status-indicator').nextSibling.textContent.toLowerCase().trim();

            let matchesSearch = !searchTerm || userName.includes(searchTerm) || userEmail.includes(searchTerm);

            // Fix role comparison (admin vs administrator logic if needed, or exact match)
            let matchesRole = !roleVal || roleBadge.includes(roleVal);

            let matchesStatus = true;
            if (statusVal) {
                if (statusVal === 'active') matchesStatus = statusText === 'active' || statusText === 'aktif';
                else if (statusVal === 'inactive') matchesStatus = statusText !== 'active' && statusText !== 'aktif';
            }

            if (matchesSearch && matchesRole && matchesStatus) {
                user.style.display = 'block';
            } else {
                user.style.display = 'none';
            }
        });
    }

    searchInput.addEventListener('input', filterUsers);
    roleFilter.addEventListener('change', filterUsers);
    statusFilter.addEventListener('change', filterUsers);
</script>