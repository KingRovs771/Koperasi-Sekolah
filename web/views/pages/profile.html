<style>
    .profile-section, .security-section, .notification-section {
        border-left: 3px solid;
    }
    .profile-section { border-color: #1e40af; }
    .security-section { border-color: #ef4444; }
    .notification-section { border-color: #f59e0b; }

    /* Modal Styles (Scoped) */
    .modal {
        display: none;
        position: fixed;
        z-index: 60;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        align-items: center;
        justify-content: center;
    }
    /* Override flex display for modals when active */
    .modal.active { display: flex !important; }

    .modal-content {
        background-color: white;
        padding: 1.5rem;
        border-radius: 16px;
        width: 95%;
        max-width: 450px;
        position: relative;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: scaleUp 0.2s ease-out;
    }
    @keyframes scaleUp {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    @media (max-width: 768px) {
        .profile-grid { grid-template-columns: 1fr !important; }
    }
</style>
<div class="fade-in">
    <div class="profile-grid grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="lg:col-span-1">
            <div class="bg-white p-6 rounded-xl shadow text-center border border-gray-100">
                <div class="mb-4 relative inline-block">
                    {{ if .User.Foto }}
                    <img src="/uploads/profiles/{{ .User.Foto }}" alt="Foto Profil" class="w-24 h-24 rounded-full mx-auto border-4 border-blue-50 object-cover">
                    {{ else }}
                    <img src="https://placehold.co/120x120/1e40af/white?text={{ printf "%.2s" .User.NamaLengkap }}" alt="Foto Profil" class="w-24 h-24 rounded-full mx-auto border-4 border-blue-50">
                    {{ end }}

                    <button class="absolute bottom-0 right-0 bg-white rounded-full p-1.5 shadow-md hover:bg-gray-50 border border-gray-200 transition"
                            onclick="document.getElementById('upload-photo').click()" title="Ganti Foto">
                        <i class="fas fa-camera text-gray-600 text-xs"></i>
                    </button>
                </div>
                <h2 class="text-xl font-bold text-gray-800 mb-1 capitalize">{{ .User.NamaLengkap }}</h2>
                <p class="text-primary font-medium mb-2 text-sm bg-blue-50 inline-block px-3 py-1 rounded-full uppercase">{{ .Role }}</p>
                <p class="text-gray-500 text-sm mb-4">{{ .User.Email }}</p>

                <input type="file" id="upload-photo" name="photo" accept="image/*" class="hidden">
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="bg-white p-6 rounded-xl shadow border border-gray-100 h-full">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Informasi Akun</h3>
                    <button class="text-primary hover:text-blue-700 text-sm font-medium transition" onclick="showEditProfileModal()">
                        <i class="fas fa-edit mr-1"></i> Edit
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Username</p>
                            <p class="font-medium text-gray-800">{{ .User.Username }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Status</p>
                            <p class="font-medium text-green-600 flex items-center">
                                <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Aktif
                            </p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Bergabung Sejak</p>
                            <p class="font-medium text-gray-800">{{ .User.CreatedAt.Format "02 Jan 2006" }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Nomor Handphone</p>
                            <p class="font-medium text-gray-800">{{ if .User.NoHp }}{{ .User.NoHp }}{{ else }}-{{ end }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <div class="profile-section p-6 bg-white rounded-xl shadow border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-user-circle text-primary mr-2"></i>
                Informasi Pribadi
            </h3>
            <form id="form-info" onsubmit="submitUpdateProfile(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                    <input type="text" name="nama_lengkap" value="{{ .User.NamaLengkap }}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nomor Handphone</label>
                    <input type="tel" name="no_hp" value="{{ .User.NoHp }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Alamat</label>
                    <textarea name="alamat" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none transition" rows="3">{{ .User.Alamat }}</textarea>
                </div>
                <div class="pt-2 text-right">
                    <button type="submit" id="btn-save-info" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition text-sm">
                        <i class="fas fa-save mr-1"></i> Simpan
                    </button>
                </div>
            </form>
        </div>

        <div class="security-section p-6 bg-white rounded-xl shadow border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-shield-alt text-danger mr-2"></i>
                Keamanan & Password
            </h3>
            <form id="form-password" onsubmit="submitUpdatePassword(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password Saat Ini</label>
                    <input type="password" name="old_password" required placeholder="••••••••" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password Baru</label>
                    <input type="password" name="new_password" id="new_pwd" required placeholder="Masukkan password baru" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Konfirmasi Password Baru</label>
                    <input type="password" id="confirm_pwd" required placeholder="Ulangi password baru" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none transition">
                </div>
                <div class="pt-2 text-right">
                    <button type="submit" id="btn-save-pwd" class="px-4 py-2 bg-danger text-white rounded-lg hover:bg-red-700 transition text-sm">
                        <i class="fas fa-key mr-1"></i> Update Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="edit-profile-modal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Edit Akun</h3>
            <button onclick="hideEditProfileModal()" class="text-gray-500 hover:text-gray-700 transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="form-modal-info" onsubmit="submitUpdateProfile(event)" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                <input type="text" name="username" value="{{ .User.Username }}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none transition">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" name="email" value="{{ .User.Email }}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none transition">
            </div>
            <div class="flex justify-end space-x-3 pt-2">
                <button type="button" onclick="hideEditProfileModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm">Batal</button>
                <button type="submit" id="btn-modal-save" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition text-sm">Simpan Perubahan</button>
            </div>
        </form>
    </div>
</div>

<script>
    // FUNGSI 1: Update Profil (Dipakai oleh Form Informasi Pribadi dan Form Modal)
    async function submitUpdateProfile(e) {
        e.preventDefault();
        const form = e.target;
        const btn = form.querySelector('button[type="submit"]');
        const originalHtml = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

        try {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            const res = await fetch('/profile/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();

            if (res.ok) {
                alert("✅ " + result.message);
                location.reload(); // Reload agar data baru tampil
            } else {
                alert("❌ Gagal: " + result.error);
            }
        } catch (err) {
            alert("⚠️ Kesalahan koneksi");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    // FUNGSI 2: Update Password
    async function submitUpdatePassword(e) {
        e.preventDefault();
        const form = e.target;
        const pwd = document.getElementById('new_pwd').value;
        const confirm = document.getElementById('confirm_pwd').value;

        // Validasi Front-end
        if (pwd !== confirm) {
            return alert("❌ Konfirmasi password tidak cocok!");
        }

        const btn = document.getElementById('btn-save-pwd');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

        try {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            const res = await fetch('/profile/password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();

            if (res.ok) {
                alert("✅ " + result.message);
                form.reset();
            } else {
                alert("❌ Gagal: " + result.error);
            }
        } catch (err) {
            alert("⚠️ Kesalahan koneksi");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    // FUNGSI 3: Upload Foto Langsung via File Input
    document.getElementById('upload-photo').addEventListener('change', async function(e) {
        if (e.target.files.length === 0) return;

        const file = e.target.files[0];
        if (!file.type.startsWith('image/')) {
            alert('❌ Harap pilih file gambar (JPG/PNG)!');
            e.target.value = '';
            return;
        }

        const formData = new FormData();
        formData.append("photo", file);

        try {
            // Tampilkan state loading
            document.body.style.cursor = 'wait';

            const res = await fetch('/profile/photo', {
                method: 'POST',
                body: formData
            });
            const result = await res.json();

            if (res.ok) {
                alert("✅ " + result.message);
                location.reload();
            } else {
                alert("❌ Gagal upload foto: " + result.error);
            }
        } catch (err) {
            alert("⚠️ Terjadi kesalahan saat mengupload foto.");
        } finally {
            document.body.style.cursor = 'default';
        }
    });

    // FUNGSI MODAL
    function showEditProfileModal() {
        document.getElementById('edit-profile-modal').classList.add('active');
    }

    function hideEditProfileModal() {
        document.getElementById('edit-profile-modal').classList.remove('active');
    }

    window.onclick = function(event) {
        const editModal = document.getElementById('edit-profile-modal');
        if (event.target === editModal) {
            hideEditProfileModal();
        }
    };
</script>